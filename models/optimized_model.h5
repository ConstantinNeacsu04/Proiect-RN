import tensorflow as tf
from tensorflow.keras.models import load_model
from tensorflow.keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras import optimizers

# --- CONFIGURARE ---
MODEL_INITIAL = 'trained_model.h5'
BASE_DIR = 'imagini antrenare'
IMG_SIZE = (180, 180)

# 1. Încărcăm modelul din Etapa 5
print("Se încarcă modelul baseline pentru optimizare...")
model = load_model(MODEL_INITIAL)

# 2. ACTIVĂM FINE-TUNING
# Permitem straturilor profunde să învețe detalii specifice despre scule
model.trainable = True 

# 3. COMPILARE CU LEARNING RATE MIC
# Folosim 0.00001 (foarte mic) pentru precizie chirurgicală
model.compile(
    optimizer=optimizers.Adam(learning_rate=1e-5),
    loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True),
    metrics=['accuracy']
)

# 4. PREGĂTIRE DATE (Cu augmentare agresivă)
datagen = ImageDataGenerator(
    rescale=1./255,
    rotation_range=30,
    zoom_range=0.3,
    horizontal_flip=True,
    validation_split=0.2
)

train_gen = datagen.flow_from_directory(
    BASE_DIR, target_size=IMG_SIZE, batch_size=16, subset='training'
)
val_gen = datagen.flow_from_directory(
    BASE_DIR, target_size=IMG_SIZE, batch_size=16, subset='validation'
)

# 5. ANTRENARE FINALĂ (Scurtă și intensă)
print("Se execută pașii de optimizare finală...")
model.fit(train_gen, validation_data=val_gen, epochs=5)

# 6. SALVARE MODEL FINAL
model.save('optimized_model.h5')
print("\n✅ SUCCES! 'optimized_model.h5' a fost creat și este gata de utilizare.")